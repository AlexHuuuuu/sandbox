---
title: "Recommender Systems"
---

This script was inspired by the following: https://ashokharnal.wordpress.com/2014/12/18/using-recommenderlab-for-predicting-ratings-for-movielens-data/

```{r}
library(recommenderlab)
library(tidyverse)
```


```{r}
data(MovieLense)
r <- MovieLense
r
str(r)
# Look at the first few rows. Need to turn it into a data frame first, because
head(as(r, "data.frame"), n=20)
```
 
 
# Explore and Visualize

First, convert to a dataframe:

```{r}
df = as(r, "data.frame")
str(df)
nrow(df)
```

Let's look at the rating distribution:

```{r}
ggplot(df, aes(rating)) + geom_histogram(binwidth=0.5) + ggtitle("Number of each movie rating.")
```


Let's look at the most popular movies (with at least 10 ratings):

```{r}
movie_stats <- df %>%
  group_by(item) %>%
  summarise(mean_rating = mean(rating), count=n())
```

```{r}
movie_stats %>% filter(count > 10) %>%
  arrange(desc(mean_rating)) %>%
  head(50)
```

And the least popular movies:

```{r}
movie_stats %>% filter(count > 10) %>%
  arrange(mean_rating) %>%
  head(50)
```

And the most rated movies:

```{r}
movie_stats %>% arrange(desc(count)) %>%
  head(50)

movie_stats %>% ggplot(aes(count)) + geom_histogram(binwidth=5) + ggtitle("Number of ratings per movie")
```

Let's look at users: the distribution of users' average ratings.

```{r}
user_stats <- df %>%
  group_by(user) %>%
  summarise(mean_rating = mean(rating), count=n())

user_stats %>% ggplot(aes(mean_rating)) + geom_histogram(binwidth=0.2) + ggtitle("Average movie rating per user")
user_stats %>% ggplot(aes(count)) + geom_histogram(binwidth=5) + ggtitle("Number of movies rated per user")
```

Let's look at a image plot or raw-ratings:

```{r}
image(r, main = "Ratings")
```


# Create a recommender (model)

There are a couple of different algorithms in the package:

- UBCF: User-based collaborative filtering
- IBCF: Item-based collaborative filtering

The `method` parameter controls similarity metric: cosine or Jaccard.

```{r}
rec=Recommender(r[1:nrow(r)],method="UBCF", param=list(normalize = "Z-score", method="Cosine",nn=5))
rec=Recommender(r[1:nrow(r)],method="UBCF", param=list(normalize = "Z-score", method="Jaccard",nn=5, minRating=1))
rec=Recommender(r[1:nrow(r)],method="IBCF", param=list(normalize = "Z-score", method="Jaccard"))
```


# Create Predictions

The `predict` method will predict ratings for all the movies that users did not rate.
We can then turn it into a data frame, and look at the predictions for each user.

```{r}
recom <- predict(rec, r[1:nrow(r)], type="ratings")

df.pred <- as(recom, "data.frame")
df.pred %>% 
  filter(user == 3) %>%
  arrange(desc(rating))

dim(tmp1)

tmp2 = df.pred %>% filter(user==1)
dim(tmp2)

df.pred
df.both <- df %>%
  left_join(df.pred, by=c('user', 'item'))
df.both
```


# Examination of model

```{r}
# Convert prediction into list, user-wise
as(recom, "list")
# Study and Compare the following:
as(r, "matrix")     # Has lots of NAs. 'r' is the original matrix
as(recom, "matrix") # Is full of ratings. NAs disappear
as(recom, "matrix")[,1:10] # Show ratings for all users for items 1 to 10
as(recom, "matrix")[5,3]   # Rating for user 5 for item at index 3
as.integer(as(recom, "matrix")[5,3]) # Just get the integer value
as.integer(round(as(recom, "matrix")[6039,8])) # Just get the correct integer value
as.integer(round(as(recom, "matrix")[368,3717])) 
```